### 消息队列

进程间通信的工具,“消息”是在两台计算机间传送的数据单位

##### 应用场景

1. 异步处理
2. 服务解耦
3. 流量削峰

#####  消息模型

1. 队列
2. 发布/订阅

##### 消费方式

1. pull
2. push

##### 消息不丢失

三阶段: 

1. 生产: 告警+重试
2. 刷盘: 单机刷盘后返回, 集群2个以上副本ok后再返回
3. 消费: 事务提交后再删除

##### 消息去重

1. 幂等: **前置条件判断**, **唯一键**
2. 根据消息最长存活时间为有效期去重

##### 消息的有序性

**全局有序**: 一个生产者-一个topic,一个队列,一个消费者单线程消费

**局部有序**: 通过特定的策略发消息到固定的队列中, 每个队列由一个消费者单线程消费

##### 消息堆积

原因: **生产者的生产速度与消费者的消费速度不匹配**

方案: 

1. 定位消费bug
2. 提高消费者速率, 增加队列扩容



##### AMQP高级消息队列协议

AMQP（Advanced Message Queuing Protocol，高级消息队列协议）是一个进程间传递**异步消息**的**网络协议**。

AMQP 连接通常是长连接。AMQP 是一个使用 **TCP** 提供可靠投递的应用层协议。AMQP 使用认证机制并且提供 **TLS**（SSL）保护。当一个应用不再需要连接到 AMQP 代理的时候，需要优雅的释放掉 AMQP 连接，而不是直接将 TCP 连接关闭。

交换器(exchange) => 从topic路由消息标签到对应的队列



##### 延迟消息功能

DelaySeconds 入参，取值范围为0 - 3600秒，即消息最长不可见时长为1小时

##### 消息回溯

在业务成功消费并删除消息后重新消费已删除的消息。

##### 事务消息

发送事务消息包含以下两个步骤：

1. 发送半消息并执行本地事务
2. 提交本地事务执行状态

若消息队列未收到事务提交/回滚, 则发送回查, 业务需要实现回调, 并返回正确的事务状态:commit/rollback

